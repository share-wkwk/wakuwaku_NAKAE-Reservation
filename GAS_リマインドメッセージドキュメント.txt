GPTï¼šhttps://chatgpt.com/share/68a70a71-0dc4-800e-8a52-0b2332e5e026

äºˆç´„å‰æ—¥ãƒªãƒžã‚¤ãƒ³ãƒ‰ï¼šå®Ÿè£…æ‰‹é †ï¼ˆGAS + Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ + LINEï¼‰
0. ä»•æ§˜ï¼ˆã‚µãƒžãƒªï¼‰

å¯¾è±¡ï¼šç¿Œæ—¥ã®Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ

æ¡ä»¶ï¼šã‚¤ãƒ™ãƒ³ãƒˆã®**å ´æ‰€ï¼ˆLocationï¼‰æ¬„ã«ã€Œè­˜åˆ¥IDï¼ˆï¼LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã€**ãŒå…¥ã£ã¦ã„ã‚‹ã‚‚ã®ã ã‘

å‹•ä½œï¼šè©²å½“ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«ã€ãã®è­˜åˆ¥IDã®LINEå‹ã ã¡ã¸ãƒªãƒžã‚¤ãƒ³ãƒ‰ï¼ˆFlexï¼‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡

é€ä¿¡å†…å®¹ï¼šæ—¥ä»˜ãƒ»æ™‚é–“ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆèª¬æ˜Žæ¬„ã‹ã‚‰æŠ½å‡ºï¼‰ã€æŒ¨æ‹¶

1. äº‹å‰æº–å‚™

LINE Developers

Messaging APIãƒãƒ£ãƒãƒ«ä½œæˆ

**ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé•·æœŸï¼‰**ã‚’æŽ§ãˆã‚‹

Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼

ãƒªãƒžã‚¤ãƒ³ãƒ‰å¯¾è±¡ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ±ºã‚ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’æŽ§ãˆã‚‹
ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ è¨­å®š â†’ å¯¾è±¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®çµ±åˆã€â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDï¼‰

ã‚¤ãƒ™ãƒ³ãƒˆã®å…¥åŠ›ãƒ«ãƒ¼ãƒ«

ã‚¤ãƒ™ãƒ³ãƒˆã®**å ´æ‰€ï¼ˆLocationï¼‰æ¬„ï¼šè­˜åˆ¥IDï¼ˆï¼LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰**ã‚’å…¥ã‚Œã‚‹

ã‚¤ãƒ™ãƒ³ãƒˆã®èª¬æ˜Žï¼ˆDescriptionï¼‰æ¬„ï¼š
ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥ã‚Œã‚‹å ´åˆã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã«å›²ã†ã¨è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™

â‰ªãƒ¡ãƒ‹ãƒ¥ãƒ¼â‰«
ã€‡ã€‡ã‚³ãƒ¼ã‚¹ 90åˆ†
â‰ª

2. GASï¼ˆApps Scriptï¼‰ã«è²¼ã‚Šä»˜ã‘ã‚‹ã‚³ãƒ¼ãƒ‰

Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ã§æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ä¸‹è¨˜ã‚’ä¸¸ã”ã¨ã‚³ãƒ”ãƒš

å…ˆã« ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€â†’ã€Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ ã«
LINE_CHANNEL_ACCESS_TOKEN ã¨ CALENDAR_ID ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆæ‰‹é †ã¯æ¬¡ç« ï¼‰

/**
 * äºˆç´„å‰æ—¥ãƒªãƒžã‚¤ãƒ³ãƒ‰ï¼ˆç¿Œæ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’èµ°æŸ»ã—ã€å ´æ‰€ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå®›ã«LINEãƒ—ãƒƒã‚·ãƒ¥ï¼‰
 * ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã€ã§åº—èˆ—ã®TZã«åˆã‚ã›ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šAsia/Tokyoï¼‰
 */
function sendReminderMessages() {
  // ===== è¨­å®šå€¤ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å–å¾— =====
  const props = PropertiesService.getScriptProperties();
  const LINE_CHANNEL_ACCESS_TOKEN = props.getProperty('LINE_CHANNEL_ACCESS_TOKEN'); // LINEé•·æœŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
  const calendarId = props.getProperty('CALENDAR_ID'); // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID

  if (!LINE_CHANNEL_ACCESS_TOKEN || !calendarId) {
    console.error('å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£(LINE_CHANNEL_ACCESS_TOKEN / CALENDAR_ID)ãŒæœªè¨­å®šã§ã™ã€‚');
    return;
  }

  const LINE_API_URL = 'https://api.line.me/v2/bot/message/push';

  // ===== å¯¾è±¡æœŸé–“ï¼šç¿Œæ—¥ 00:00ã€œç¿Œæ—¥ 23:59ï¼ˆå†…éƒ¨ã¯TZã«ä¾å­˜ï¼‰ =====
  const now = new Date();
  const tz = Session.getScriptTimeZone(); // ä¾‹: Asia/Tokyo
  const y = now.getFullYear();
  const m = now.getMonth();
  const d = now.getDate();

  const start = new Date(y, m, d + 1, 0, 0, 0);   // ç¿Œæ—¥00:00
  const end   = new Date(y, m, d + 2, 0, 0, 0);   // ç¿Œã€…æ—¥00:00ï¼ˆæŽ’ä»–çš„ï¼‰

  // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾— =====
  const cal = CalendarApp.getCalendarById(calendarId);
  if (!cal) {
    console.error('æŒ‡å®šã—ãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }

  // ç¿Œæ—¥ã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
  const events = cal.getEvents(start, end);
  if (events.length === 0) {
    console.log('ç¿Œæ—¥ã®å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
    return;
  }

  // ===== æ›œæ—¥è¡¨è¨˜ï¼ˆæ—¥æœ¬èªžï¼‰ =====
  const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆèµ°æŸ» =====
  events.forEach(event => {
    const userId = (event.getLocation() || '').trim(); // å ´æ‰€æ¬„ã«LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    if (!userId) return; // è­˜åˆ¥IDãŒç„¡ã„ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—

    // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
    const startTime = event.getStartTime();
    const dateText =
      Utilities.formatDate(startTime, tz, 'yyyyå¹´MMæœˆddæ—¥') +
      'ï¼ˆ' + weekdays[startTime.getDay()] + 'ï¼‰ ' +
      Utilities.formatDate(startTime, tz, 'HHæ™‚mmåˆ†');

    const description = event.getDescription() || '';

    // â‰ªãƒ¡ãƒ‹ãƒ¥ãƒ¼â‰« ... â‰ª ã§å›²ã‚ã‚ŒãŸæœ¬æ–‡ã‚’æŠ½å‡ºï¼ˆä»»æ„ï¼‰
    let menuText = 'æœªè¨­å®š';
    const menuMatch = description.match(/â‰ªãƒ¡ãƒ‹ãƒ¥ãƒ¼â‰«\s*([\s\S]*?)â‰ª/);
    if (menuMatch && menuMatch[1]) {
      menuText = menuMatch[1].trim();
    }

    // ===== Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒªãƒžã‚¤ãƒ³ãƒ‰ï¼‰ =====
    const flexMessage = {
      type: 'flex',
      altText: 'ã”äºˆç´„å‰æ—¥ã®ãƒªãƒžã‚¤ãƒ³ãƒ‰ã§ã™',
      contents: {
        type: 'bubble',
        size: 'mega',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            { type: 'text', text: 'ã€äºˆç´„å‰æ—¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘', color: '#ffffff', size: 'xl', weight: 'bold' }
          ],
          paddingAll: '16px',
          backgroundColor: '#877059'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            { type: 'text', text: 'æ˜Žæ—¥ã®ã”äºˆç´„ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™', weight: 'bold', size: 'lg', color: '#333333', wrap: true, align: 'center', margin: 'md' },
            { type: 'separator', margin: 'lg', color: '#CCCCCC' },
            {
              type: 'box',
              layout: 'vertical',
              margin: 'lg',
              contents: [
                { type: 'text', text: 'ðŸ“… æ—¥æ™‚', color: '#666666', size: 'sm', weight: 'bold', margin: 'md' },
                { type: 'text', text: dateText, wrap: true, size: 'sm', color: '#333333', margin: 'xs' },
                { type: 'text', text: 'ðŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼', color: '#666666', size: 'sm', weight: 'bold', margin: 'lg' },
                { type: 'text', text: menuText, wrap: true, size: 'sm', color: '#333333', margin: 'xs' }
              ]
            },
            { type: 'separator', margin: 'xxl', color: '#CCCCCC' },
            { type: 'text', text: 'ã”æ¥åº—ã‚’å¿ƒã‚ˆã‚ŠãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™', wrap: true, margin: 'xl', size: 'sm', align: 'center', color: '#474646' }
          ]
        }
      }
    };

    // ===== LINEãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡ =====
    const payload = { to: userId, messages: [flexMessage] };
    const options = {
      method: 'post',
      contentType: 'application/json',
      headers: { Authorization: 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    try {
      const res = UrlFetchApp.fetch(LINE_API_URL, options);
      const code = res.getResponseCode();
      if (code >= 200 && code < 300) {
        console.log(`é€ä¿¡æˆåŠŸ: ${userId} ã«ãƒªãƒžã‚¤ãƒ³ãƒ‰é€ä¿¡`);
      } else {
        console.error(`é€ä¿¡å¤±æ•—(${code}): ${res.getContentText()}`);
      }
    } catch (e) {
      console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  });
}

/**
 * æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ï¼šä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ãƒ€ãƒŸãƒ¼ã®ãƒªãƒžã‚¤ãƒ³ãƒ‰ã‚’é€ã‚‹
 * - ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã« TEST_USER_ID ã‚’è¨­å®šã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ä¾¿åˆ©ã§ã™
 */
function debugSendTest() {
  const props = PropertiesService.getScriptProperties();
  const testUserId = props.getProperty('TEST_USER_ID');
  if (!testUserId) {
    console.error('TEST_USER_ID ãŒæœªè¨­å®šã§ã™');
    return;
  }
  // ç°¡æ˜“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç–Žé€šãƒã‚§ãƒƒã‚¯
  const token = props.getProperty('LINE_CHANNEL_ACCESS_TOKEN');
  const url = 'https://api.line.me/v2/bot/message/push';
  const payload = {
    to: testUserId,
    messages: [{ type: 'text', text: 'ãƒ†ã‚¹ãƒˆï¼šå‰æ—¥ãƒªãƒžã‚¤ãƒ³ãƒ‰é€ä¿¡ãƒ†ã‚¹ãƒˆã§ã™ã€‚' }]
  };
  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: { Authorization: 'Bearer ' + token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  const res = UrlFetchApp.fetch(url, options);
  console.log('TEST RES', res.getResponseCode(), res.getContentText());
}

3. æ©Ÿå¯†æƒ…å ±ã®è¨­å®šï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰

Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ â†’ æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šï¼‰ â†’ ä¸‹éƒ¨ã®**ã€Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€** â†’ ã€Œè¿½åŠ ã€

ä»¥ä¸‹ã®ã‚­ãƒ¼ã¨å€¤ã‚’è¿½åŠ 

LINE_CHANNEL_ACCESS_TOKENï¼šLINEã®ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³

CALENDAR_IDï¼šäºˆç´„ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID

ï¼ˆä»»æ„ï¼‰TEST_USER_IDï¼šãƒ†ã‚¹ãƒˆç”¨ã«è‡ªåˆ†ã®LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID

â€» ã‚³ãƒ¼ãƒ‰ç›´æ›¸ãã‚ˆã‚Šå®‰å…¨ã€‚æ¨©é™ã®ã‚ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ä»¥å¤–ã«æ¼ã‚Œã«ããã€å·®ã—æ›¿ãˆã‚‚å®¹æ˜“ã€‚

4. ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰

Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ â†’ å·¦å´ã€Œæ™‚è¨ˆã€ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ â†’ ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ 

å®Ÿè¡Œã™ã‚‹é–¢æ•°ï¼šsendReminderMessages

ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ï¼šæ™‚é–“ä¸»å°Žåž‹

æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼ï¼šæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒžãƒ¼

å®Ÿè¡Œæ™‚åˆ»ï¼šæ¯Žæ—¥ 19:00 ãªã©ï¼ˆãŠåº—ã«åˆã‚ã›ã¦è¨­å®šï¼‰

ä¾‹ï¼‰ã€Œå‰æ—¥ã®19:00ã«ç¿Œæ—¥ã®äºˆç´„ã‚’ã¾ã¨ã‚ã¦é€šçŸ¥ã€ãªã©

5. ã‚ˆãã‚ã‚‹QA

Q. ã‚¤ãƒ™ãƒ³ãƒˆãŒå–å¾—ã•ã‚Œãªã„
A. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã®é–“é•ã„ï¼ãƒˆãƒªã‚¬ãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³é•ã„ï¼ç¿Œæ—¥ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒç„¡ã„ã€ãªã©ã‚’ç¢ºèª

Q. èª°ã«ã‚‚å±Šã‹ãªã„
A. ã‚¤ãƒ™ãƒ³ãƒˆã®å ´æ‰€ï¼ˆLocationï¼‰ã«LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆç©ºæ¬„ã ã¨ã‚¹ã‚­ãƒƒãƒ—ï¼‰

Q. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã€Œæœªè¨­å®šã€ã«ãªã‚‹
A. èª¬æ˜Žæ¬„ã®è¨˜è¿°ãŒ**ã€Œâ‰ªãƒ¡ãƒ‹ãƒ¥ãƒ¼â‰« â€¦ â‰ªã€**ã®å½¢å¼ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

6. å¤‰æ›´ãƒã‚¤ãƒ³ãƒˆï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã¨ã®é•ã„ï¼‰

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç®¡ç†ã«å¤‰æ›´ï¼ˆå®‰å…¨æ€§å‘ä¸Šï¼‰

ç¿Œæ—¥ç¯„å›²ã‚’00:00ã€œ24:00ã§ç¶²ç¾…ï¼ˆå–ã‚Šã“ã¼ã—é˜²æ­¢ï¼‰

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°ã‚’èª¿æ•´ï¼ˆåŽŸå› è¿½è·¡ã—ã‚„ã™ãï¼‰

ãƒ†ã‚¹ãƒˆé–¢æ•° debugSendTest ã‚’è¿½åŠ ï¼ˆç–Žé€šç¢ºèªã—ã‚„ã™ãï¼‰